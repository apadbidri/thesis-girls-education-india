---
title: "MSc thesis working script"
author: 'Alyssa Padbidri'
date: "`r Sys.Date()`"
output: html_document
---

```{r setup}
library(haven) # to read stata files 
library(dplyr)  

demographic_info <- read_dta("inchildlevel8yrold.dta") %>%
  mutate(childid_clean = sub("^IN", "", as.character(childid)))

r1_roster <- read_dta("r1hhroster.dta") %>%
  mutate(childid_clean = sub("^IN", "", as.character(childid)))

cog_df <- read_dta("IN_R4_OCCOG_OlderChild.dta") %>%
  mutate(CHILDCODE = as.character(CHILDCODE))

roster_df  <- read_dta("IN_R4_OCHH_HouseholdRosterR4.dta") %>%
  mutate(CHILDCODE = as.character(CHILDCODE))

r4_child   <- read_dta("IN_R4_OCCH_OlderChild.dta") %>%
  mutate(CHILDCODE = as.character(CHILDCODE))


merged_df <- demographic_info %>%
  left_join(cog_df,    by = c("childid_clean" = "CHILDCODE")) %>%
  left_join(r4_child,  by = c("childid_clean" = "CHILDCODE")) 

merged_df <- merged_df %>%
  mutate(birth_order = order + 1)

# Mother's education: relate == 1 and sex == 2
mother_edu <- r1_roster %>%
  filter(relate == 1, sex == 2) %>%
  select(childid_clean, mother_edu = yrschool)

# Father's education: relate == 1 and sex == 1
father_edu <- r1_roster %>%
  filter(relate == 1, sex == 1) %>%
  select(childid_clean, father_edu = yrschool)

# Merge both into merged_df
merged_df <- merged_df %>%
  left_join(mother_edu, by = "childid_clean") %>%
  left_join(father_edu, by = "childid_clean")

# Create sibling status variables directly in merged_df
merged_df <- merged_df %>%
  mutate(
    # Total siblings
    n_siblings = brothers + sisters,
    
    # Binary indicators
    has_brother   = ifelse(brothers >= 1, 1, 0),
    has_sister   = ifelse(sisters >= 1, 1, 0),
    has_siblings  = ifelse(n_siblings >= 1, 1, 0),
    
    # Label for descriptive purposes
    brother_status = ifelse(has_brother == 1, "Has Brother", "No Brother")
  )


girls_df <- merged_df %>% filter(sex == 2)
boys_df  <- merged_df %>% filter(sex == 1)

summary(girls_df$has_brother)
```

```{r data_cleaning}

# Overview of missingness
# List of variables
vars <- c("has_brother", "wi", "sv", "hhsize", "mother_edu", "father_edu", 
          "chldeth", "typesite", "birth_order", 
          "engl_perco", "lang_perco", "maths_perco", "HGHQULR4")

# Count and percentage of missing values
missing_summary <- data.frame(
  Variable = vars,
  Missing_Count = sapply(girls_df[vars], function(x) sum(is.na(x))),
  Missing_Percent = sapply(girls_df[vars], function(x) mean(is.na(x)) * 100)
)

# View the summary
print(missing_summary)


# Drop rows with less than 10% missingness
girls_df_cleaned <- girls_df %>%
  filter(!is.na(has_brother), !is.na(mother_edu), !is.na(father_edu))


# Example: Filter for non-missing outcome in math_perco model
math_model_df <- girls_df_cleaned %>%
  filter(!is.na(maths_perco))

eng_model_df <- girls_df_cleaned %>%
  filter(!is.na(engl_perco))

lang_model_df <- girls_df_cleaned %>%
  filter(!is.na(lang_perco))

HGHQULR4_model_df <- girls_df_cleaned %>%
  filter(!is.na(HGHQULR4))
```

```{r descriptives}

library(flextable)

# Count 
girls_df %>%
  group_by(brother_status) %>%
  summarise(count = n())


# Compute group means & SDs
descriptives <- girls_df %>%
  group_by(brother_status) %>%
  summarise(
    hhsize = paste0(round(mean(hhsize, na.rm = TRUE), 2), " (", round(sd(hhsize, na.rm = TRUE), 2), ")"),
    mother_edu = paste0(round(mean(mother_edu, na.rm = TRUE), 2), " (", round(sd(mother_edu, na.rm = TRUE), 2), ")"),
    father_edu = paste0(round(mean(father_edu, na.rm = TRUE), 2), " (", round(sd(father_edu, na.rm = TRUE), 2), ")"),
    wealth = paste0(round(mean(wi, na.rm = TRUE), 2), " (", round(sd(wi, na.rm = TRUE), 2), ")"),
    service = paste0(round(mean(sv, na.rm = TRUE), 2), " (", round(sd(sv, na.rm = TRUE), 2), ")"),
    caste = paste0(round(mean(chldeth, na.rm = TRUE), 2), " (", round(sd(chldeth, na.rm = TRUE), 2), ")"),
    birth_order = paste0(round(mean(birth_order, na.rm = TRUE), 2), " (", round(sd(birth_order, na.rm = TRUE), 2), ")"),
    enrollment_rate = paste0(round(mean(ENRSCHR4 == 1, na.rm = TRUE) * 100, 1), "%"),
    grade = paste0(round(mean(HGHQULR4, na.rm = TRUE), 2), " (", round(sd(HGHQULR4, na.rm = TRUE), 2), ")"),
    maths = paste0(round(mean(maths_perco, na.rm = TRUE), 2), " (", round(sd(maths_perco, na.rm = TRUE), 2), ")"),
    english = paste0(round(mean(engl_perco, na.rm = TRUE), 2), " (", round(sd(engl_perco, na.rm = TRUE), 2), ")"),
    language = paste0(round(mean(lang_perco, na.rm = TRUE), 2), " (", round(sd(lang_perco, na.rm = TRUE), 2), ")"),
    .groups = "drop"
  )

print(descriptives)

# Create nice labels
descriptives <- descriptives %>%
  rename(
    `Household Size` = hhsize,
    `Mother's Education` = mother_edu,
    `Father's Education` = father_edu,
    `Wealth Index` = wealth,
    `Access to Services` = service,
    `Caste (ethnicity)` = caste,
    `Birth Order` = birth_order,
    `Enrollment Rate` = enrollment_rate,
    `Highest Grade` = grade,
    `Maths Score` = maths,
    `English Score` = english,
    `Language Score` = language
  )

# Convert to flextable
ft <- flextable(descriptives)
ft <- set_header_labels(ft, brother_status = "Brother Status")
ft <- autofit(ft)

# Export to Word
flextable::save_as_docx(
  "Descriptive Statistics by Brother Status" = ft,
  path = "descriptive_stats_landscape.docx",
  pr_section = officer::prop_section(
    page_size = officer::page_size(orient = "landscape")  # Set entire doc to landscape
  )
)

```

```{r girls_OLS_models}

# English scores
model_english <- lm(engl_perco ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = eng_model_df)
summary(model_english)

# Maths scores
model_maths <- lm(maths_perco ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = math_model_df)
summary(model_maths)

# Language scores
model_lang <- lm(lang_perco ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = lang_model_df)
summary(model_lang)

# Grade completed
model_grade <- lm(HGHQULR4 ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = HGHQULR4_model_df)
summary(model_grade)

```

```{r balance_tests}
balance_check <- function(df, group_var, vars) {
  group <- as.factor(df[[group_var]])   # <-- force factor
  
  results <- lapply(vars, function(var) {
    x <- df[[var]]
    if (length(levels(group)) < 2) {
      return(data.frame(
        Variable = var,
        Mean_Group0 = NA,
        Mean_Group1 = NA,
        p_value = NA
      ))
    }
    if (is.numeric(x)) {
      # t-test for continuous
      test <- t.test(x ~ group)
      data.frame(
        Variable = var,
        Mean_Group0 = mean(x[group == levels(group)[1]], na.rm = TRUE),
        Mean_Group1 = mean(x[group == levels(group)[2]], na.rm = TRUE),
        p_value = test$p.value
      )
    } else {
      # chi-square for categorical
      tab <- table(x, group)
      if (min(dim(tab)) < 2) {
        return(data.frame(
          Variable = var,
          Mean_Group0 = NA,
          Mean_Group1 = NA,
          p_value = NA
        ))
      }
      test <- chisq.test(tab)
      data.frame(
        Variable = var,
        Mean_Group0 = NA,
        Mean_Group1 = NA,
        p_value = test$p.value
      )
    }
  })
  
  do.call(rbind, results)
}


# --- Select variables to check ---
balance_vars <- c("birth_order", "wi", "sv", "hhsize", "mother_edu", "father_edu", "typesite", "chldeth")

# --- Run for Girls ---
girls_balance <- balance_check(girls_df, "has_brother", balance_vars)

girls_balance <- girls_balance %>%
  mutate(p_value = round(p_value, 3))
print("Balance check for GIRLS:")
print(girls_balance)
```

```{r lnp_first_girl}
# Load required packages
library(dplyr)
library(sandwich)
library(lmtest)
library(modelsummary)

# Prepare variables
merged_df <- merged_df %>%
  mutate(
    is_girl = ifelse(sex == 2, 1, 0)            # 1 = girl, 0 = boy
  )

# Run Linear Probability Model (LPM)
model_lpm <- lm(
  is_girl ~ birth_order + chldeth + mother_edu + father_edu + wi + typesite,
  data = merged_df
)

summary(model_lpm)

merged_df$WHICHSEX

```

```{r boys_df_tests}
boys_df <- boys_df %>%
  mutate(brother_status = ifelse(has_brother == 1, "Has Brother", "No Brother"))

# English scores
boy_model_english <- lm(engl_raw ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = boys_df)

# Maths scores
boy_model_maths <- lm(maths_raw ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = boys_df)

# Language scores
boy_model_lang <- lm(lang_raw ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = boys_df)

# Grade completed
boy_model_grade <- lm(HGHQULR4 ~ has_brother + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_brother + wi * has_brother, data = boys_df)


summary(boy_model_english)
summary(boy_model_maths)
summary(boy_model_lang)
summary(boy_model_grade)

```

```{r sisters_test}
# Grade completed
# English scores
sis_model_english <- lm(engl_raw ~ has_sister + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_sister + wi * has_sister, data = girls_df)

# Maths scores
sis_model_maths <- lm(maths_raw ~ has_sister + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_sister + wi * has_sister, data = girls_df)

# Language scores
sis_model_lang <- lm(lang_raw ~ has_sister + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_sister + wi * has_sister, data = girls_df)

# Grade completed
sis_model_grade <- lm(HGHQULR4 ~ has_sister + wi + sv + hhsize + mother_edu + father_edu + chldeth + typesite + birth_order + birth_order * has_sister + wi * has_sister, data = girls_df)


summary(sis_model_english)
summary(sis_model_maths)
summary(sis_model_lang)
summary(sis_model_grade)

```




